{% include 'signup/includes/header-signup.html' %}
{% load static %}
<style>
    .default_card {
        border: #9dcfd7 5px solid;
    }
    .year-span{
        font-size: 20px;
        font-weight: 400;
    }
</style>
<div class="signup-page step-page ptb-50">
    <div class="container">
        <div class="form-wrapper text-center">
            <h1>Payment</h1>
            <p>Step 3 of 3</p>
            <form id="add-card" action="{% url 'users:payment' %}" method="POST">
                {% csrf_token %}
                <input type="hidden" value="{{user.id}}" name="user">
                <div class="form-inner">
                    <div class="payment-card" style="cursor:pointer;">
                        <h4>{{all_plans.title}} </h4>
                        <h2 style="font-weight: 500">${{all_plans.price}}<span class="year-span"> / {% if plan.valid_for == 1 %}per month{% else %}per year{% endif %}</span></h2>
                    </div>
                    <input type="hidden" name="plan" value="{{all_plans.id}}" id="plan" />
                    <input type="hidden" name="coupon_id" value="" id="coupon_id" />
                    <input type="hidden" name="price" value="{{all_plans.price}}" id="price" />
                    <input type="hidden" name="default_price" value="{{all_plans.price}}" id="default_price" />
                    <div class="offer-text payment-card" style="display:none">
                        <h6 style="font-weight:400" class="mt-1">
                            Total Amount to pay now : <b class="mr-2 ml-2">$<span id="amount"></span></b>  (<span id="off_percentage"></span>% Off)</h6>
                    </div>
                    <div class="row form-row payment-card">
                        <div class="col-lg-12">
                            <div class="form-group">
                                <input type="text" id="card_no" name="ac_no" value="{{ac_no}}" class="form-control" onkeypress="return /[0-9]/i.test(event.key)" placeholder="Card Number">
                            </div>
                        </div>
                        <div class="col-lg-12">
                            <div class="form-group">
                                <input type="text" onkeypress="return /[a-zA-z\s]/i.test(event.key)" value="{{card_holder_name}}" name="card_holder_name" class="form-control" placeholder="Card Holder Name" maxlength="50">
                            </div>
                        </div>
                        <div class="col-lg-6 col-sm-8 col-6">
                            <div class="form-group">
                                <input type="text" id="ex_date" class="form-control" name="expire_date" value="{{expire_date}}" placeholder="Expiration Date">
                            </div>
                        </div>
                        <div class="col-lg-6 col-sm-4 col-6">
                            <div class="form-group">
                                <input type="text" onkeypress="return /[0-9]/i.test(event.key)" maxlength="4" value="{{cvv}}" name="cvv" class="form-control" placeholder="CVV">
                            </div>
                        </div>
                        <div class="col-lg-12">
                            <div class="input-group">
                                <input type="text" name="coupon" id="coupon" maxlength="15" onkeypress="return /[0-9A-Z]/i.test(event.key)" class="form-control mb-0" placeholder="Enter coupon code">
                                <div class="input-group-append coupon-btn">
                                    <a onclick="CheckCoupon();" class="input-group-text btn ">Update total</a>
                                </div>
                            </div>
                            <p class="error error-text"></p>
                        </div>
                    </div>
                    <div class="button-wrap">
                        <button type="submit" class="btn btn-theme secondary-btn w-100">Process Payment</button>
                    </div>
                    <p class="mt-3">By clicking verify now you agree to our <a class="payment-a" target="_blank" href="{% url 'frontend:terms_and_conditions' %}">terms and conditions</a>
                    </p>
                </div>
            </form>
        </div>
    </div>
</div>

{% include 'frontend/includes/footer.html' %}
<script>
    $('#add-card').submit(function(e){
        if ($('#plan').val() == ''){
            alert('Please select a plan to continue!');
            e.preventDefault(); 
        } 
    });
    function selectCard(event,id) {
        $('.payment-card').removeClass('default_card').filter(event).toggleClass('default_card');
        $('#plan').val(id);
    };
    function CheckCoupon(){
        if ($('#coupon').val() == ''){
            $('.error-text').css('display','block');
            $('#price').val($('#default_price').val());
            $('.error-text').html('Please enter a coupon code').delay(1000).fadeOut(1000);  
            $('.offer-text').css('display','none');
            $('#coupon_id').val("");
            
        }
        else{
            $.ajax({
                url: "{% url 'users:check_coupon' %}",
                type: 'GET',
                data: { 'coupon': $('#coupon').val() },
                success: function (data) {
                    if (data.exists == '0'){
                        $('.error-text').css('display','block');
                        $('.error-text').html('Invalid coupon code!');
                        $('.offer-text').css('display','none');
                        $('#coupon_id').val("");
                        $('#price').val($('#default_price').val());
                    }else{
                        $('.error-text').html('');
                        $('.offer-text').css('display','block');
                        $('#amount').text(data.amount_pay);
                        $('#price').val(data.amount_pay);
                        $('#coupon_id').val(data.user_coupon);
                        $('#off_percentage').text(data.off_percenatage);
                    }
                }
            });
        }
    }
</script>
<script type="text/javascript">
    $("#add-card").validate({
        rules: {
            expire_date: {
                required: true,
                minlength: 7,
                maxlength: 7,
            },
            card_holder_name: {
                required: true,
                normalizer: function( value ) {
                    return $.trim( value );
                }
            },
            ac_no: {
                required: true,
                maxlength: 25,
            },
            cvv: {
                required: true,
                number: true,
                minlength: 3
            }
        },
        messages: {
            expire_date: {
                required: "Please enter expiration date",
                minlength: "Please enter a valid expiration date",
                maxlength: "Please enter a valid expiration date"
            },
            card_holder_name: {
                required: "Please enter card holder name"
            },
            ac_no: {
                required: "Please enter card number",
                maxlength: "Please enter a valid account number"
            },
            cvv: {
                required: "Please enter cvv",
                minlength: "Please enter a valid cvv",
                maxlength: "Please enter a valid cvv"
            }
        }
    });
</script>
<script type="text/javascript">
    // enable spacing for credit card number     
    $('#card_no').on('keyup', function (e) {
        var val = $(this).val();
        var newval = '';
        val = val.replace(/\s/g, '');
        for (var i = 0; i < val.length; i++) {
            if (i % 4 == 0 && i > 0) newval = newval.concat(' ');
            newval = newval.concat(val[i]);
        }
        $(this).val(newval);
    });
</script>
<script type="text/javascript">
    var app;
    (function () {
        'use strict';
        app = {
            monthRegex: /^\d\d$/, // regex to match "MM"
            el_expDate: '#ex_date',
        };
        app.addListeners = function () {
            $(app.el_expDate).on('keydown', function (e) {
                app.removeSlash(e);
            });
            $(app.el_expDate).on('keyup', function (e) {
                app.addSlash(e);
            });
            $(app.el_expDate).on('blur', function (e) {
                app.populateDate(e);
            });
            $(app.el_cvv + ', ' + app.el_expDate).on('keypress', function (e) {
                return e.charCode >= 48 && e.charCode <= 57;
            });
        };

        app.addSlash = function (e) {
            var isMonthEntered = app.monthRegex.exec(e.target.value);
            if (e.key >= 0 && e.key <= 9 && isMonthEntered) {
                e.target.value = e.target.value + " / ";
            }
        };

        app.populateDate = function (e) {
            var month, year;
            if (e.target.value.length == 7) {
                month = parseInt(e.target.value.slice(0, -5));
                year = "20" + e.target.value.slice(5);
                if (app.checkMonth(month)) {
                    $(app.el_monthSelect).val(month);
                } else {
                    $(app.el_monthSelect).val(0);
                }
                if (app.checkYear(year)) {
                    $(app.el_yearSelect).val(year);
                } else {
                    $(app.el_yearSelect).val(0);
                }
            }
        };

        app.init = function () {
            $(document).find(app.el_cardNumber).each(function () {
                var $elem = $(this);
                if ($elem.is('input')) {
                    $elem.on('input', function () {
                        app.monitorCcFormat($elem);
                    });
                }
            });
            app.addListeners();
        }();
    })();
</script>